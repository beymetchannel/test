<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/png" href="BeyMetCupIcon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="BeyMetCupIcon.png">
  <link rel="shortcut icon" type="image/png" href="BeyMetCupIcon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="100戦杯リザルト">
  <title>100戦杯リザルト</title>
  <style>
    /* --- 全体 --- */
    :root{
      --bg:#ffffff;
      --text:#111;
      --accent:#00FFF0;
      --danger:#C00000;
      --muted: rgba(0,0,0,0.5);
      --card-bg: #fff;
      --card-border: rgba(0,0,0,0.06);
      --color: #fff;
    }
    body {
      background: url('BackImage.png') no-repeat center center fixed;
      background-size: cover;
      color: var(--text);
      font-family: "Noto Sans JP", "Yu Gothic", sans-serif;
      padding: 18px;
    }

    .page-header {
      max-width:520px;
      display: flex;
      gap: 12px;
      color: #fff; /* 文字色を白に */
      font-size: 18px;
      font-weight: 700;
      width: 100%;
      margin: 0 auto; 
    }
    .header-title{
      display: flex;
      justify-content: center; 
      text-align: center; 
      width: 100%;
    }

    /* --- Top info (画像＋タイトル＋勝率等) --- */
    .header {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 0px;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(2px); 
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      padding: 12px 0;
      color: #fff;
      width: 100%;
      max-width:520px;
    }
    .header .blade-name,
    .header .blade-spec,
    .header .big-rate,
    .header .small-stats {
      color: #fff;
    }


    .ranking-box {
      width:100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0px;
      margin:0px;
      background: rgba(255, 255, 255, 0.05);
      padding: 0px;
      border-radius: 10px; 
      backdrop-filter: blur(10px);
    }


    .ranking-label {
      font-size: 8px;
      letter-spacing: 2px;
      color: #fff;
      padding: 10px;
    }

    .ranking-value {
      font-size: 40px;
      font-weight: bold;
      color: #fff;
    }
    .rank-warning {
      color: #fff;
      text-shadow: 0 0 5px #ffe72e, 0 0 10px #ffe72e;
      filter: drop-shadow(0 0 6px #ffe72e);
    }


    .reload-btn {
      margin: 0px;
      display: flex;  
      align-items: center;  
      justify-content: center;
      gap: 0px;
      padding: 5px;
      font-size: 5px;
      color: #fff;
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 5px;
      backdrop-filter: blur(4px);
      cursor: pointer;
      transition: 0.2s;
      text-decoration: none;
      width: 100%; 
    }

    .reload-text {
      font-size: 10px;
    }
    .reload-icon {
      width: 10px;
      height: 10px;
      object-fit: contain;
    }



    .ranking-wrap {
      display: flex;
      flex-direction: column;  /* ←縦並び */
      align-items: center;
      gap: 0px;
      width: 18%;
      /*margin: 0px;*/
    }


    .head-main {
      display:flex;
      flex-direction:column;
      gap:4px;
      width: 100%;
    }
    .title-row {
      display: flex;
      flex-direction: column; 
      width: 100%; 
      
    }
    .blade-name {
      font-weight:800;
      font-size:20px;
      letter-spacing:0.3px;
      
    }
    .blade-spec {
      color:var(--muted);
      font-size:14px;
      
    }
    .stats-row {
      display: flex;
      flex-direction: column;
      width: 100%;
      gap: 4px;
    }
    .big-rate {
      font-size: 28px; 
      font-weight: 800;
      color: var(--text);
      flex-shrink: 0; 
    }
    .stats-row > .big-rate,
    .stats-row > .small-stats,
    .stats-row > .side-rate-row {
      width: 100%;
    }
    
    .small-stats,
    .side-rate-row {
      font-size: 12px;
      display: flex;
      gap: 2px;
    }

    /* --- Card container --- */
    .gear-cards {
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:8px;
      max-width:520px;
    }
    .gear-card {
      background: rgba(0, 0, 0, 0.6); /* 黒半透明 */
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(2px);
      color: #fff; /* 文字色を白に変更 */
    }
    .gear-card .gear-title,
    .gear-card .gear-sub,
    .gear-card .gear-sub .value,
    .gear-card .gear-sub .label,
    .gear-card .gear-thumb,
    .gear-card .finish-text,
    .gear-card .finish-label,
    .gear-card .bar-win,
    .gear-card .bar-lose {
      color: #fff;
    }
    .gear-card .gear-sub .label,
    .gear-card .gear-sub span#gearPointsVal1,
    .gear-card .gear-sub span#gearNegPointsVal1 {
      color: rgba(255,255,255,0.8);
    }

    .gear-head {
      display:flex;
      align-items:center;
      gap:12px;
      cursor:pointer;
      user-select:none;
    }
    .gear-head-left {
      display:flex;
      align-items:center;
      gap:10px;
      flex:1;
    }
    .gear-head .gear-winrate {
      font-size: 20px; /* 大きく表示 */
      font-weight: 800;
      color: var(--text);
      margin-left: auto; /* 右端に表示したい場合 */
    }

    .gear-thumb {
      width:44px; height:44px; border-radius:6px; overflow:hidden; background:transparent; flex-shrink:0;
      display:flex; align-items:center; justify-content:center;
    }
    .gear-thumb img{ width:100%; height:100%; object-fit:cover; }

    .gear-title {
      font-weight:800;
      font-size:16px;
    }
    .gear-sub {
      font-size:14px;
      color:var(--muted);
      margin-top:2px;
    }
      .gear-sub .label {
      font-size:12px; 
      color:var(--muted);
      margin-right:2px;
    }

    .gear-sub .value {
      font-size:18px;  
      font-weight:800;
      color:var(--text);
      margin-right:8px;
    }

    .gear-sub span#gearPointsVal1,
    .gear-sub span#gearNegPointsVal1 {
      font-size:14px;      
      color:var(--muted);
      margin-left:0px;
      font-weight:800;
    }


    .caret {
      transition: transform .28s ease;
      width:18px; height:18px; display:inline-block;
    }
    .gear-card.open .caret { transform: rotate(180deg); }

    /* --- expandable content --- */
    .gear-body {
      margin-top:10px;
      overflow:hidden;
      max-height:0;
      transition: max-height .32s ease, opacity .22s ease;
      opacity:0;
    }
    .gear-card.open .gear-body {
      opacity:1;
      max-height: 420px; /* enough for content */
    }

    /* --- top summary inside card --- */
    .gear-summary {
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:8px;
    }
    .gear-summary .rate {
      font-size:20px;
      font-weight:800;
      color:var(--text);
      min-width:86px;
    }
    .gear-summary .points {
      font-size:13px;
      color:var(--muted);
    }

    /* --- Finish bars --- */
    .finish-block {
      width:100%;
      margin-top:6px;
      padding-right:4px;
    }
    .finish-row {
      display:flex;
      align-items:center;
      gap:8px;
      margin:1px 0;
    }
    .finish-wrap {
      display: flex;
      align-items: flex-start;   /* 上揃え */
      gap: 5px;          /* FINISH と WIN/LOSE の間隔 */
    }
    .finish-label {
      font-size: 24px;    /* 大きいFINISH */
      font-weight: 900;
      color: #fff;
      text-align: right;
      width: 32px;
    }
    .win-row, .lose-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .result-small {
      display: flex;
      flex-direction: column;
      gap: 0px;
      flex: 1;
    }
    .win-label,
    .lose-label {
      font-size: 22px;
      font-weight: 700;
      color: #fff;
      padding: 4px 12px;
      border-radius: 6px;
      width: fit-content;
    }
    .win-label {
      background: #4cb44c;
    }

    .lose-label {
      background: #3c3c3c;
    }
    .finish-text {
      font-size: 12px;          /* 小さめ */
      color: #fff;
      min-width: 50px;
      text-align: right;
      padding-top: 2px;
    }
    .finish-pair {
      display: flex;
      flex-direction: column;
      gap: 0; /* win/loseバーの間隔をゼロにする */
      margin-bottom: 5px; /* ペア間のスペース */
    }

    .finish-row {
      display:flex;
      align-items:center;
      gap:5px;
      margin:0;
    }


    .bar-container {
      flex:1;
      height:16px;
      background: rgba(0,0,0,0.06);
      border-radius:0;
      overflow:hidden;
      display:flex;
      align-items:center;
    }
    .bar-win {
      height: 100%;
      width: 0;
      background: linear-gradient(
        to right,
        rgba(0, 255, 192, 0) 0%,
        rgba(0, 255, 192, 0.8) 100%
      );
      transition: width .4s ease;
      border-radius: 0;        /* ← 角丸を無効化 */
    }
    .bar-lose {
      height: 100%;
      width: 0;
      background: linear-gradient(
        to right,
        rgba(192, 0, 0, 0) 0%,
        rgba(192, 0, 0, 0.8) 100%
      );
      transition: width .4s ease;
      border-radius: 0;        /* ← 角丸を無効化 */
    }


    .reload-btn {
      margin: 10px auto 0;
      display: inline-flex;      
      align-items: center;  
      gap: 2px;      
      padding: 6px 12px;     
      font-size: 12px;
      color: #fff;
      background: rgba(255,255,255,0.01);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 5px;
      backdrop-filter: blur(4px);
      cursor: pointer;
      transition: 0.2s;
      text-decoration: none;
    }

    .reload-btn .reload-icon {
      width: 16px;    /* アイコンサイズ：調整可 */
      height: 16px;
      display: block;
      object-fit: contain;
      filter: none;   /* 必要なら色変換や明るさを調整 */
    }
    .ranking-wrap {
      display: flex;
      flex-direction: column;  /* ←縦並び */
      align-items: center;
      gap: 6px;
      width: 18%;
      margin: 10px;
    }

    @media (max-width:520px){
      .gear-cards{ max-width:100%; }
    }


    /* --- 全体カード --- */
    .blader-card {
      width: 100%;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    /* --- ヘッダー部分（閉じている時） --- */
    .blader-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(0,0,0,0.4);
      cursor: pointer;
      backdrop-filter: blur(4px);
    }

    /* 左：相手の名前 */
    .opponent-name {
      color: #fff;
      font-size: 14px;
    }

    /* 右：勝敗のタグ */
    .battle-result {
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,0.3);
    }

    /* 勝敗色 */
    .tag-win { color: #ffe72e; border-color: #ffe72e; }
    .tag-lose { color: #aaa; }
    .tag-dlow { color: #2ee6ff; }
    .tag-none { color: #999; }

    /* --- 展開部分 --- */
    .blader-body {
      display: none;
      flex-direction: column;
      background: rgba(0,0,0,0.3);
      padding: 6px 10px;
      gap: 6px;
    }

    /* レコードの1行 */
    .battle-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 6px;
      font-size: 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
    }

    /* 勝敗ごとの色 */
    .win-side { color: #ffe72e; font-weight: bold; }
    .lose-side { color: #888; }


  </style>
</head>
<body>
  <div class="page-header">
    <span class="header-title">BEYMETCUP 100戦杯</span>
  </div>
  <div class="header">
    <div class="ranking-wrap">
      <div class="ranking-box">
        <div class="ranking-label">RANKING</div>
        <div class="ranking-value" id="rankingResult">-</div>
      </div>

      <button class="reload-btn" onclick="location.reload()">
        <img src="ReloadIcon.png" class="reload-icon">
        <span class="reload-text">更新</span>
      </button>
    </div>

    <div class="head-main">
      <div class="title-row">
        <div class="blade-name" id="bladeTitle">---</div>
        <div class="blade-spec" id="bladeSpec">---</div>
      </div>
      <div class="stats-row">
        <div class="big-rate" id="overallRate">-</div>

        <div class="small-stats">
          得点：<span id="totalPoints">0</span> / 
          失点：<span id="totalNegPoints">0</span>
        </div>

        <div class="side-rate-row">
          L勝率：<span id="lSideRate">-</span> / 
          R勝率：<span id="rSideRate">-</span>
        </div>
      </div>
    </div>
  </div>

</div>



    </div>
  </div>

  <div class="gear-cards">
    <div class="gear-card" id="gearCard1">
      <div class="gear-head" data-index="1">
        <div class="gear-head-left">
          <div class="gear-thumb" id="gearThumb1"></div>
          <div>
            <div class="gear-title" id="gearTitle1">...</div>
            <div class="gear-sub" id="gearSub1">
              <span class="label">勝率:</span>
              <span class="value" id="gearWinRateVal1">-</span>
              <span class="label">得点:</span>
              <span id="gearPointsVal1">0</span>
              <span class="label">失点:</span>
              <span id="gearNegPointsVal1">0</span>
            </div>
          </div>
        </div>
        <div class="caret">▼</div>
      </div>
      <div class="gear-body" id="gearBody1">
        <div class="finish-block" id="finishBlock1"></div>
      </div>
    </div>

    <div class="gear-card" id="gearCard2">
      <div class="gear-head" data-index="2">
        <div class="gear-head-left">
          <div class="gear-thumb" id="gearThumb2"></div>
          <div>
            <div class="gear-title" id="gearTitle2">...</div>
            <div class="gear-sub" id="gearSub2">
              <span class="label">勝率:</span>
              <span class="value" id="gearWinRateVal2">-</span>
              <span class="label">得点:</span>
              <span id="gearPointsVal2">0</span>
              <span class="label">失点:</span>
              <span id="gearNegPointsVal2">0</span>
            </div>
          </div>
        </div>
        <div class="caret">▼</div>
      </div>
      <div class="gear-body" id="gearBody2">
        <div class="finish-block" id="finishBlock2"></div>
      </div>
    </div>

    <div class="gear-card" id="gearCard3">
      <div class="gear-head" data-index="3">
        <div class="gear-head-left">
          <div class="gear-thumb" id="gearThumb3"></div>
          <div>
            <div class="gear-title" id="gearTitle3">...</div>
            <div class="gear-sub" id="gearSub3">
              <span class="label">勝率:</span>
              <span class="value" id="gearWinRateVal3">-</span>
              <span class="label">得点:</span>
              <span id="gearPointsVal3">0</span>
              <span class="label">失点:</span>
              <span id="gearNegPointsVal3">0</span>
            </div>
          </div>
        </div>
        <div class="caret">▼</div>
      </div>
      <div class="gear-body" id="gearBody3">
        <div class="finish-block" id="finishBlock3"></div>
      </div>
    </div>  

    <div class="result-card">
      <!-- 1人のブレーダーにつき1枚 -->
      <div class="blader-card">
        <div class="blader-header">
          <span class="opponent-name">OpponentName</span>
          <span class="battle-result tag-win">Win</span>
        </div>

        <div class="blader-body">
          <!-- JSでレコードごとに追加される -->
          <!-- 例 -->
          <div class="battle-row">
            <span class="my-bey win-side">Aero</span>
            <span class="battle-detail">SF</span>
            <span class="opp-bey lose-side">Phoenix</span>
          </div>
        </div>
      </div>
    </div>

  
  </div>

  <script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

const supabaseUrl = 'https://ddmjevqneetbmahtcqdl.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkbWpldnFuZWV0Ym1haHRjcWRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NzM5MTksImV4cCI6MjA3ODU0OTkxOX0.L63jZ8n7MjsTuGaNYYyRWvxOM-gzYlFzIMuZ4gvgHrk';
const supabase = createClient(supabaseUrl, supabaseKey);

// 既存の targetBlader ロジックに合わせる（URL id かデフォルト）
const urlParams = new URLSearchParams(window.location.search);
const inputPassword = urlParams.get('id');
let targetBlader = inputPassword

// ヘルパー：Finishキーマップ
const finishMap = {
  "Spin": "SF",
  "Burst": "BF",
  "Over": "OF",
  "Xtreme": "XF"
};

// ヘルパー：先頭トークン（ベイ名の1つ目のスペースまで）
function firstToken(str) {
  if (!str || typeof str !== 'string') return '';
  return str.split(' ')[0];
}

// ヘルパー：クラス付与用（勝者=黄色, 敗者=グレー, 引き分けは無し）
function getSideClass(myPoint, oppPoint) {
  if (myPoint > oppPoint) return { mine: 'win-side', opp: 'lose-side' };
  if (myPoint < oppPoint) return { mine: 'lose-side', opp: 'win-side' };
  return { mine: '', opp: '' }; // 引き分けはデフォルト
}

// 初期ユーザー取得（パスワード経由で Name を取得する既存ロジック再現）
async function resolveTargetBlader() {
  if (!inputPassword) return; // 既にデフォルトが使われる
  const { data: userData, error } = await supabase
    .from('UserDB')
    .select('Name')
    .eq('Password', inputPassword)
    .single();

  if (error) {
    console.warn('該当するユーザーがいません', error);
    return;
  }
  if (userData && userData.Name) targetBlader = userData.Name;
}

// メイン：ResultDB と UserDB を取得し、opponentCards をレンダーする
async function renderOpponentCards() {
  // resolve target first
  await resolveTargetBlader();

  // DOM 参照先（result-card 内に <div id="opponentCards"> を用意してください）
  const wrap = document.getElementById('opponentCards');
  if (!wrap) {
    console.warn('opponentCards 要素が見つかりません。HTMLに <div id="opponentCards"></div> を配置してください。');
    return;
  }
  wrap.innerHTML = ''; // クリア

  // fetch both tables
  const [{ data: users = [], error: userErr }, { data: results = [], error: resultErr }] = await Promise.all([
    supabase.from('UserDB').select('*'),
    supabase.from('ResultDB').select('*')
  ]);

  if (userErr) { console.error('UserDB fetch error', userErr); return; }
  if (resultErr) { console.error('ResultDB fetch error', resultErr); return; }

  // 自分以外のブレーダー一覧（UserDB の登録者のみ表示）
  const opponents = (users || []).filter(u => u.Name && u.Name !== targetBlader);

  // 先に opponentsMap（自分 vs opponent の合算）を作る（効率化）
  // key: opponentName -> { myTotal, oppTotal, records: [...] }
  const pairMap = {};
  // iterate over all results and collect records that include targetBlader
  results.forEach(row => {
    const L = row.LBlader, R = row.RBlader;
    if (L !== targetBlader && R !== targetBlader) return; // 対象外

    // Determine opponent and which side target was on for this record
    const isLeft = (L === targetBlader);
    const opponent = isLeft ? R : L;
    if (!opponent) return;

    if (!pairMap[opponent]) pairMap[opponent] = { myTotal: 0, oppTotal: 0, records: [] };

    const myPoint = isLeft ? (Number(row.LPoint) || 0) : (Number(row.RPoint) || 0);
    const oppPoint = isLeft ? (Number(row.RPoint) || 0) : (Number(row.LPoint) || 0);

    pairMap[opponent].myTotal += myPoint;
    pairMap[opponent].oppTotal += oppPoint;
    // keep the original row + meta for rendering
    pairMap[opponent].records.push(Object.assign({}, row, { targetIsLeft: isLeft }));
  });

  // For each opponent from UserDB, build the card
  opponents.forEach(op => {
    const name = op.Name;
    const entry = pairMap[name] || { myTotal: 0, oppTotal: 0, records: [] };
    let headerResult = '-';
    if (entry.records.length === 0) {
      headerResult = '-';
    } else if (entry.myTotal > entry.oppTotal) {
      headerResult = 'Win';
    } else if (entry.myTotal < entry.oppTotal) {
      headerResult = 'Lose';
    } else {
      headerResult = 'Dlow'; // your wording for draw
    }

    // create elements
    const card = document.createElement('div');
    card.className = 'blader-card';

    // header
    const header = document.createElement('div');
    header.className = 'blader-header';
    header.innerHTML = `
      <span class="opponent-name">${escapeHtml(name)}</span>
      <span class="battle-result ${headerResult === 'Win' ? 'tag-win' : headerResult === 'Lose' ? 'tag-lose' : headerResult === 'Dlow' ? 'tag-dlow' : 'tag-none'}">${headerResult}</span>
    `;
    card.appendChild(header);

    // body (initially hidden)
    const body = document.createElement('div');
    body.className = 'blader-body';
    // if no records, show a placeholder row
    if (entry.records.length === 0) {
      const emptyRow = document.createElement('div');
      emptyRow.className = 'battle-row';
      emptyRow.innerHTML = `<div style="width:100%; text-align:center; color:#999; font-size:12px;">-</div>`;
      body.appendChild(emptyRow);
    } else {
      // sort records by TimeStamp if present (optional)
      entry.records.sort((a,b) => {
        if (!a.TimeStamp || !b.TimeStamp) return 0;
        return new Date(a.TimeStamp) - new Date(b.TimeStamp);
      });

      entry.records.forEach(rec => {
        // compute left/right display according to "展開後は必ず左側に自分、右側に相手"
        // The requirement: left = 自分のベイ名 (first token), center = content (SF~XF), right = opponent bey (first token)
        const isLeft = rec.targetIsLeft; // true if target is LBlader in this record
        const myBeyFull = isLeft ? rec.LBey : rec.RBey;
        const oppBeyFull = isLeft ? rec.RBey : rec.LBey;
        const myPoint = isLeft ? Number(rec.LPoint) || 0 : Number(rec.RPoint) || 0;
        const oppPoint = isLeft ? Number(rec.RPoint) || 0 : Number(rec.LPoint) || 0;

        const myBey = escapeHtml(firstToken(myBeyFull));
        const oppBey = escapeHtml(firstToken(oppBeyFull));
        const finKey = finishMap[rec.Finish] || (rec.Finish ? escapeHtml(rec.Finish) : '');

        const sideClass = getSideClass(myPoint, oppPoint);

        // create row
        const row = document.createElement('div');
        row.className = 'battle-row';
        row.innerHTML = `
          <span class="my-bey ${sideClass.mine}">${myBey}</span>
          <span class="battle-detail">${finKey}</span>
          <span class="opp-bey ${sideClass.opp}">${oppBey}</span>
        `;
        body.appendChild(row);
      });
    }

    card.appendChild(body);
    wrap.appendChild(card);

    // click toggle (tapで展開)
    header.addEventListener('click', () => {
      const isOpen = body.style.display === 'flex';
      if (isOpen) {
        body.style.display = 'none';
      } else {
        body.style.display = 'flex';
        body.style.flexDirection = 'column';
      }
    });
  });
}

// HTML エスケープ（簡易）
function escapeHtml(str) {
  if (str === null || str === undefined) return '';
  return String(str)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');
}

// calcResults は既存の集計を行う関数（あなたが既に持っている calcResults をそのまま使ってOK）
// ここでは calcResults のあとに renderOpponentCards を呼ぶようにするのが良い。
// もし calcResults をこのファイル内で定義しているなら、calcResults の最後に await renderOpponentCards(); を追加してください。
// 既存コードの最後で calcResults() を呼んでいるので、その後に renderOpponentCards() を呼び出します。

// すでに別で calcResults() を定義しているなら下の呼び出しは二重呼び出しに注意。
// ここでは安全に両方呼ぶために Promise.resolve().then(...)
Promise.resolve().then(async () => {
  // 既存 calcResults() がグローバルに存在するなら呼び出す（なければスキップ）
  if (typeof calcResults === 'function') {
    try { await calcResults(); } catch (e) { console.warn('calcResults error', e); }
  }
  // レンダリング（ResultDB と UserDB を参照して opponentCards を生成）
  try { await renderOpponentCards(); } catch (e) { console.error('renderOpponentCards error', e); }
});

</script>

